---
title: "paperCode"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{paperCode}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(RCAmla)
```

This vignette is a companion to the paper `The maximally selected likelihood 
ratio test in random coefficient models.' The code to build all figures in that
paper are presented.

The stationary region was built using the following code.
```{r, stationaryRegion, eval=F}
set.seed(12345)
data_sr <- simulateStationaryRegion(nSims = 10000000, silent=T)
```

The results of that code includes Figure \ref{fig:stationaryRegion}.
```{r, loadStationaryRegion, echo=F}
data_sr <- readRDS("./data-paper/stationaryRegion.RDS")
```

```{r, plotStationaryRegion fig.cap = '\\label{fig:stationaryRegion}Simulation stationary region using Gaussian error based on $E\\log |\\beta + \\epsilon_{0,1} |$'}
data_sr[[3]]
```

The empirical rejection frequencies under the null case was generated using the following code.
```{r, empiricalRejection, eval=F}
data_er <- simulationTable_NC(betas = c(0.5,0.75,1,1.05), 
                              varProbRates = c(0.5, 0.5),
                              nSims=500, iterations = c(100, 200, 400, 800), 
                              burnin = 1000, lowerEst=c(-Inf,0,10^-8,-Inf), 
                              upperEst=c(Inf,Inf,Inf,Inf), alpha = 0.05,
                              errorTypes = c('Normal','Bernoulli','Exponential'),
                              CPLoc=0.5, nStart=NA, nEnd=NA, seed=1234,trimAmt=14)
```


The results of that code can be used to create Table \ref{tab:empiricalRejection}.
```{r, loadEmpiricalRejection, echo=F}
data_er <- readRDS("./data-paper/simTable.RDS")
```

```{r, tableStationaryRegion}
data_er$errType <- ifelse(data_er$errType=='Normal','N',
                          ifelse(data_er$errType=='Bernoulli','B','E'))
tmp <- data_er %>%
  dplyr::select(-c(Lower,Upper)) %>%
  pivot_wider(names_from = c(iters,errType), values_from = Estim)

kable(tmp[,!(colnames(tmp)%in%c('beta'))], booktabs = TRUE) %>%
  pack_rows(index = table(tmp$beta))
```

The power curves were built using the following code.

```{r, powerCurves, eval=F}
tmp <- c(1, 0.9,0.75, seq(0.6,0.3,-0.1),0.25,0.1)
U4seq <- c(tmp, 0, rev(-tmp))
set.seed(1234)
pc1 <- simulatePowerCurve(Us3 = c(0, 0.5, 0.5), U4s = U4seq,
                  nSims = 500, lowerEst = c(-Inf,0,10^-8,-Inf), 
                  upperEst = rep(Inf,4), alpha = 0.05,
                  burnin = 1000, k = 0.5 * 400, N = 400, 
                  errorType = 'Normal',
                  trimAmt=14)

set.seed(1234)
pc2 <- simulatePowerCurve(Us3 = c(0, 0.5, 0.5), U4s = U4seq,
                     nSims = 500, lowerEst = c(-Inf,0,10^-8,-Inf), 
                     upperEst = rep(Inf,4), alpha = 0.05,
                     burnin = 1000, kPos = 0.9 * 400, N = 400, 
                     errorType = 'Normal',
                     trimAmt=14)

U4seq <- c(1.05,seq(1,0.6,-0.1), 0.5, seq(0.4,0,-0.1),-0.05)
set.seed(1234)
pc3 <- simulatePowerCurve(Us3 = c(0.5, 0.5, 0.5), U4s = U4seq,
                     nSims = 500, lowerEst = c(-Inf,0,10^-8,-Inf), 
                     upperEst = rep(Inf,4), alpha = 0.05,
                     burnin = 1000, kPos = 0.5 * 400, N = 400, 
                     errorType = 'Normal',
                     trimAmt=14)
set.seed(1234)
pc4 <- simulatePowerCurve(Us3 = c(0.5, 0.5, 0.5), U4s = U4seq,
                     nSims = 500, lowerEst = c(-Inf,0,10^-8,-Inf), 
                     upperEst = rep(Inf,4), alpha = 0.05,
                     burnin = 1000, kPos = 0.5 * 400, N = 400,
                     errorType = 'Bernoulli',
                     trimAmt=14)
```


The results of that code includes Figure \ref{fig:powerCurves}.
```{r, loadPowerCurves, echo=F}
pc1 <- readRDS("./data-paper/pc1.RDS")
pc2 <- readRDS("./data-paper/pc2.RDS")
pc3 <- readRDS("./data-paper/pc3.RDS")
pc4 <- readRDS("./data-paper/pc4.RDS")

## Save plots
#png(paste0("~/",fileName,".png"), width=1800, height=1000, res=250)
#print(p1[[1]])
#dev.off()
#saveRDS(p1[[2]],file=paste0("~/",fileName,'Data.RDS'))
```

```{r, plotPowerCurves fig.cap = '\\label{fig:powerCurves}Power curves as a function of the change in RCA coefficient.'}
p1[[1]]
p2[[1]]
p3[[1]]
p4[[1]]
```


The US housing figures were built using the following code.

```{r, housingData, eval=F}
housingDataList <- list()
for(city in c('Boston','LosAngeles')){
  
  ## Load data
  data <- housing[housing$city==city,c(2,3)]
  data <- data[order(data$date),]
  
  ## Detect CP
  set.seed(12345)
  result_Vost <- binarySegmentationCPDetection(fullData=data, 
                                       method='Vostrikova',
                                       lower=c(-Inf, 0, 10^-8, -Inf),
                                       upper=c(Inf, Inf, Inf, Inf),
                                       alpha=0.05, nStart=NA, nEnd=NA,
                                       trimAmt = 14, silent = T )
  
  data_plot <- renderStackedPlot(trueData = data, 
                     parCPData = result_Vost[,c(1:2,7:10)],
                     title = NULL,
                     subtitle = NULL,
                     dataName = city,
                     varPlots = FALSE)
  
  ## Save data
  housingDataList <- append(housingDataList, list(list(result_Vost,data_plot)))
}
```


The results of that code includes Figure \ref{fig:Housing}.
```{r, loadHousingData, echo=F}
housingDataList <- readRDS("./data-paper/housingDataList.RDS")

## Save plots
#png(paste0('~/',city,".png"),width = 800,height = 800)
#print(data_plot)
#dev.off()
#saveRDS(result_Vost,paste0('~/',city,'.RDS'))
```

```{r, plotHousingData fig.cap = '\\label{fig:Housing}Daily US housing price indices.'}
housingDataList[[1]][[2]]
housingDataList[[2]][[2]]
```


The UK covid figures were built using the following code.

```{r, UKCovidData, eval=F}
UKCovidList <- list()
for(nation in c('England','Northern Ireland','Scotland','Wales')){
  
  ## Load data
  data <- UKcovid[UKcovid$nation==nation,c(2,3)]
  data <- data[order(data$date),]
  
  ## Detect CP
  set.seed(12345)
  result_Vost <- binarySegmentationCPDetection(fullData=data, 
                                       method='Vostrikova',
                                       lower=c(-Inf, 0, 10^-8, -Inf),
                                       upper=c(Inf, Inf, Inf, Inf),
                                       alpha=0.05,
                                       trimAmt = 14, silent = T )
  data_plot <- renderStackedPlot(trueData = data, 
                     parCPData = result_Vost[,c(1:2,7:10)],
                     title = NULL,
                     subtitle = NULL,
                     dataName = nation,
                     varPlots = FALSE)
  
  ## Save data
  UKCovidList <- append(UKCovidList, list(list(result_Vost,data_plot)))
}
```


The results of that code includes Figure \ref{fig:UKCovid}.

```{r, loadUKCovidData, echo=F}
UKCovidList <- readRDS("./data-paper/UKCovidList.RDS")

## Save plots
#png(paste0('~/',nation,".png"), width = 800,height = 800)
#print(data_plot) 
#dev.off()
#saveRDS(result_Vost,paste0('~/',nation,'.RDS'))
```

```{r, plotUKCovidData fig.cap = '\\label{fig:UKCovid}Daily Covid-19 patients hospitalised.'}
UKCovidList[[1]][[2]]
UKCovidList[[2]][[2]]
UKCovidList[[3]][[2]]
UKCovidList[[4]][[2]]
```
